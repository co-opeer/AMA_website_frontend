<!DOCTYPE html>
<html lang="en">
<head>
    <title>Upload to Shared Google Drive</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<h1>Upload Photo to Shared Google Drive</h1>
<input type="file" id="fileInput" />
<button id="uploadButton" onclick="handleAuthClick()" disabled>Upload</button>

<script>
    var CLIENT_ID = '858949201125-hhv5q0287sn0tr84su545al0sb04auno.apps.googleusercontent.com'; // Replace with your CLIENT_ID
    var API_KEY = 'AIzaSyAPNEcOrV4KkdLOfobxUNfunfcp29ql8Q0'; // Replace with your API_KEY
    var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
    var SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile';

    var tokenClient;
    var gapiInited = false;
    var gisInited = false;

    function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
    }

    function initializeGapiClient() {
        gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: DISCOVERY_DOCS,
        }).then(function() {
            gapiInited = true;
            maybeEnableButtons();
        });
    }

    function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: handleAuthResult,
        });
        gisInited = true;
        maybeEnableButtons();
    }

    function maybeEnableButtons() {
        if (gapiInited && gisInited) {
            document.getElementById('uploadButton').disabled = false;
        }
    }

    function handleAuthClick() {
        tokenClient.requestAccessToken();
    }

    function handleAuthResult(response) {
        if (response.error !== undefined) {
            console.error('Auth error:', response.error);
            return;
        }
        getUserEmail(response.access_token);
    }

    async function getUserEmail(accessToken) {
        try {
            const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            });
            const userInfo = await response.json();
            console.log('User email:', userInfo.email);
            alert('User email: ' + userInfo.email);
            const fileId = await uploadFile(accessToken);
            await addRecordToDatabase(userInfo.email, fileId);
        } catch (error) {
            console.error('Error fetching user info:', error);
        }
    }

    async function uploadFile(accessToken) {
        var fileInput = document.getElementById('fileInput');
        var file = fileInput.files[0];
        var reader = new FileReader();
        reader.readAsArrayBuffer(file);
        return new Promise((resolve, reject) => {
            reader.onload = async function(e) {
                var content = e.target.result; // ArrayBuffer
                var metadata = {
                    'name': file.name,
                    'mimeType': file.type,
                    'parents': ['1nqwVb10YD_q21gzqc6fiKpXcZH0KCQ2q'] // Replace with your folder ID
                };
                var boundary = '-------314159265358979323846';
                var delimiter = "\r\n--" + boundary + "\r\n";
                var close_delim = "\r\n--" + boundary + "--";

                var metadataPart = delimiter +
                    'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                    JSON.stringify(metadata);

                var filePart = delimiter +
                    'Content-Type: ' + file.type + '\r\n' +
                    'Content-Transfer-Encoding: binary\r\n\r\n';

                var multipartRequestBody = new Blob([
                    metadataPart,
                    filePart,
                    new Uint8Array(content),
                    close_delim
                ]);

                var xhr = new XMLHttpRequest();
                xhr.open('POST', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart');
                xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
                xhr.setRequestHeader('Content-Type', 'multipart/related; boundary="' + boundary + '"');
                xhr.onload = function() {
                    if (xhr.status === 200) {
                        var file = JSON.parse(xhr.responseText);
                        console.log('File Id:', file.id);
                        alert('File uploaded successfully!');
                        resolve(file.id);
                    } else {
                        console.error('Upload error:', xhr.responseText);
                        alert('File upload failed.');
                        reject(xhr.responseText);
                    }
                };
                xhr.send(multipartRequestBody);
            };
        });
    }

    async function addRecordToDatabase(email, fileId) {
        try {
            const response = await fetch('http://localhost:5000/predict', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email: email, url: `https://drive.google.com/file/d/${fileId}/view?usp=sharing` })
            });
            if (response.ok) {
                console.log('Record added successfully');
            } else {
                console.error('Failed to add record');
            }
        } catch (error) {
            console.error('Error adding record to database:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (typeof gapi !== 'undefined') {
            gapiLoaded();
        } else {
            console.error('GAPI client library not loaded.');
        }

        // Wait until the Google Identity Services library is loaded
        var intervalId = setInterval(function() {
            if (typeof google !== 'undefined' && google.accounts) {
                gisLoaded();
                clearInterval(intervalId);
            }
        }, 100);
    });
</script>
</body>
</html>
